<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Receipt Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
            background-color: #f0f8ff;
            color: #000;
        }
        .dark-mode {
            background-color: #2c2c2c;
            color: #f0f8ff;
        }
        .page {
            margin: 20px auto;
            max-width: 400px;
            display: none;
            position: relative;
            min-height: 100vh;
        }
        input, select {
            display: block;
            margin: 10px auto;
            padding: 10px;
            width: 80%;
            font-size: 16px;
            background-color: inherit;
            color: inherit;
        }
        button {
            padding: 10px;
            font-size: 16px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px 0;
        }
        button:hover {
            background-color: #218838;
        }
        #add-item-button {
            background-color: #ff6600;
            font-size: 18px;
            padding: 12px;
            width: 85%;
        }
        #add-item-button:hover {
            background-color: #e65c00;
        }
        #add-new-sale-button {
            background-color: #ffcc00;
            font-size: 20px;
            padding: 15px;
            width: 90%;
            margin-top: 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }
        #add-new-sale-button:hover {
            background-color: #ffb700;
        }
        #reset-button {
            background-color: #dc3545;
            color: white;
            padding: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px 0;
            font-size: 14px;
            width: 85%;
        }
        #settings-button {
            font-size: 12px;
            background-color: #dc3545;
            margin-top: 20px;
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
        }
          {
            text-align: left;
            margin-top: 20px;
            display: none;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            background-color: inherit;
            color: inherit;
        }
        th {
            background-color: #007bff;
            color: white;
        }
        .footer {
            margin-top: 20px;
            font-size: 12px;
        }
        #shop-title {
            font-size: 28px;
            margin-bottom: 20px;
            position: relative;
            display: inline-block;
            color: white;
            background-color: #007bff;
            padding: 10px;
            border-radius: 5px;
        }
        .toggle-card-button {
            position: absolute;
            top: -5px;
            right: -35px;
            width: 20px;
            height: 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
        }
        .barcode {
            margin-top: 20px;
            text-align: center;
        }
        .compact-info {
            font-size: 12px;
            color: inherit;
            margin-top: 10px;
        }
        .business-card {
            width: 336px;
            height: 210px; 
            border: 1px solid #ccc;
            margin: 20px auto;
            display: block;
            position: relative;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            background: linear-gradient(to right, #007bff 70%, #ffffff 30%);
            color: white;
            padding: 20px;
            box-sizing: border-box;
            overflow: hidden;
        }
        .business-card h2 {
            font-family: 'Georgia', serif;
            text-align: left;
            margin: 0;
        }
        .business-card p {
            margin: 5px 0;
            font-size: 14px;
            text-align: left;
            color: #fafafa;
        }
        #card-qr-code {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 90px; 
            height: 90px;
        }
        #card-qr-code canvas {
            image-rendering: -moz-crisp-edges;
            image-rendering: -o-crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
        }
        .decorative-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40px; 
            background: linear-gradient(to right, #ffffff, #007bff);
        }
        .website-footer {
            position: absolute;
            bottom: 10px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 12px;
            color: #fafafa;
        }
        .business-card-page {
            display: none;
        }
        @media print {
    body {
        margin: 0;
        padding: 20px;
        font-size: 14px;
        color: #333;
        background-color: #fff; /* Ensure a white background for print */
    }
    #receipt {
        display: block;
        margin: 0 auto; /* Center the receipt on the page */
        width: 100%; /* Use full width for the receipt */
        max-width: 330px; /* Keep the receipt width manageable */
        box-sizing: border-box; /* Include padding and border in the element's total width and height */
        overflow: hidden; /* Prevent content overflow */
    }
    table {
        border-collapse: collapse; /* Merge table borders */
        width: 100%; /* Use full width of the container */
    }
    th, td {
        border: 1px solid #333;
        padding: 8px; /* Add padding for readability */
        text-align: left; /* Align text to the left */
        vertical-align: top; /* Align content to the top for better readability */
    }
    th {
        background-color: #007bff;
        color: white;
    }
    /* Optional: Add styles for headers or footers if required */
    .header, .footer {
        text-align: center;
        margin-bottom: 10px;
        font-weight: bold;
    }
}
        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-top: 10px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #007bff;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Add "ON" and "OFF" labels */
        .slider:after {
            content: 'OFF';
            color: white;
            position: absolute;
            transform: translate(-50%, -50%);
            top: 50%;
            left: 70%;
            font-size: 12px;
        }

        input:checked + .slider:after {
            content: 'ON';
            left: 30%;
        }
.centered-text {
    text-align: center;
}

.left-aligned-text {
    text-align: left;
}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body onload="loadShopDetails()">

    <div id="login-page" class="page">
        <h1>Shop Login</h1>
        <select id="existing-shops" onchange="selectShop()">
            <option value="">Select Existing Shop</option>
        </select>
        <input type="text" id="shop-name" placeholder="Enter Shop Name" required>
        <input type="text" id="contact-number" placeholder="Contact Number">
        <input type="text" id="address" placeholder="Address">
        <input type="text" id="owner-name" placeholder="Owner/Manager Name">
        <button onclick="login()">Login</button>
        <button onclick="createNewShop()">Create New Shop</button>
    </div>

    <div id="customer-info-page" class="page">
        <h1 id="shop-title">Shop Title 
            <button class="toggle-card-button" onclick="showBusinessCardPage()">+</button>
        </h1>
        <input type="text" id="customer-name" placeholder="Customer Name" required>
        <input type="text" id="customer-phone" placeholder="Customer Phone Number" required>
        <button id="add-new-sale-button" onclick="submitCustomerInfo()">Add New Sale</button>
        <div style="margin-top: 10px;">
            <button onclick="showHistory()">View Sales History</button>
            <button onclick="showBusinessCardPage()">Business Card</button>
        </div>
        <label class="switch">
            <input type="checkbox" onclick="toggleDarkMode()">
            <span class="slider"></span>
        </label>
        <div style="margin-top: 5px;">Dark Mode</div>
        <button id="settings-button" onclick="showSettings()">Settings</button>
    </div>

    <div id="item-entry-page" class="page">
        <h2>Enter Item Details</h2>
        <select id="existing-items" onchange="selectExistingItem()">
            <option value="">Choose Existing Item</option>
        </select>
        <input type="text" id="item-name" placeholder="Item Name" required>
        <input type="number" id="item-price" placeholder="Item Price (in ₹)" required>
        
        <!-- Quantity Selector -->
        <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 15px;">
            <button id="decrease-quantity" onclick="changeQuantity(-1)" style="width: 30px; height: 30px; font-size: 18px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">-</button>
            <input type="number" id="item-quantity" value="1" min="1" readonly style="width: 50px; text-align: center; margin: 0 10px; background-color: #f0f8ff; border: none;">
            <button id="increase-quantity" onclick="changeQuantity(1)" style="width: 30px; height: 30px; font-size: 18px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">+</button>
        </div>

        <div>
            <button id="add-item-button" onclick="addItem()">Add Item</button>
            <button onclick="printReceipt()">Print Receipt</button>
            <button onclick="notifyWhatsApp()">WhatsApp Alert</button>
            <button onclick="shareReceipt()">Share Receipt</button>
        </div>

        <button id="reset-button" onclick="resetItems()">Reset for New Sale</button>

        <h2>Receipt:</h2>
        <div id="receipt"></div>
    </div>

    <div id="history-page" class="page">
        <button onclick="exportToCSV()">Export to CSV</button>
        <button onclick="goBack()">Back</button>
        <h2>Sales History</h2>
        <div id="history"></div>
    </div>

    <!-- Business Card Page -->
    <div id="business-card-page" class="business-card-page page">
        <div id="business-card" class="business-card">
            <div id="card-qr-code"></div>
            <h2 id="card-shop-name">Shop Name</h2>
            <p id="card-owner-name">Owner Name</p>
            <p id="card-phone-number">• 1234567890</p>
            <p id="card-address">• Shop Address</p>
            <div class="decorative-bar"></div>
            <div class="website-footer">Visit us at <a href="https://thedigitsync.blogspot.com/" style="color: #fafafa;">thedigitsync.blogspot.com</a></div>
        </div>
        <button onclick="changeTheme()">Change Theme</button>
        <button onclick="downloadBusinessCard()">Download Business Card</button>
        <button onclick="goBack()">Back</button>
    </div>

    <!-- Settings Page -->
    <div id="settings-page" class="page">
        <h2>Settings</h2>
        <input type="text" id="edit-shop-name" placeholder="Shop Name" required>
        <input type="text" id="edit-contact-number" placeholder="Contact Number">
        <input type="text" id="edit-address" placeholder="Address">
        <input type="text" id="edit-owner-name" placeholder="Owner/Manager Name">
        <button onclick="saveSettings()">Save</button>
        <button onclick="logout()">Logout</button>
        <h2 style="font-size: 14px;">Receipt Generator Features</h2>
        <ul style="font-size: 12px;">
            <li><strong>Instant Receipt Creation:</strong> Quickly create receipts with barcodes for easy scanning.</li>
            <li><strong>Easy Item Management:</strong> Add items fast to make sales smoother.</li>
            <li><strong>Flexible Printing & Sharing:</strong> Print receipts on any printer, including thermal and standard, and easily share via WhatsApp and other platforms.</li>
            <li><strong>Sales History Tracking:</strong> Keep records and export transactions to CSV or Excel.</li>
            <li><strong>Multi-Shop Management:</strong> Manage multiple shops from one place.</li>
            <li><strong>User-Friendly Interface:</strong> Simple enough for everyone to use.</li>
        </ul>
        <p style="font-size: 12px;">Improve efficiency and customer service effortlessly with our Receipt Generator! Visit us at <a href="https://thedigitsync.blogspot.com/">thedigitsync.blogspot.com</a>.</p>
        <p style="font-size: 12px;">Developed by Rouf</p>
    </div>

    <script>
        let items = [];
        let shopName = '';
        let contactNumber = '';
        let address = '';
        let ownerName = '';
        let customerName = '';
        let customerPhone = '';

        function loadShopDetails() {
            let shops = JSON.parse(localStorage.getItem('shops')) || [];
            const shopSelect = document.getElementById('existing-shops');
            shopSelect.innerHTML = '<option value="">Select Existing Shop</option>';
            shops.forEach((shop, index) => {
                let option = document.createElement('option');
                option.value = index;
                option.text = shop.shopName;
                shopSelect.add(option);
            });

            const savedShopIndex = localStorage.getItem('currentShopIndex');
            if (savedShopIndex !== null && shops[savedShopIndex]) {
                applyShopDetails(savedShopIndex, shops);
            } else {
                document.getElementById('login-page').style.display = 'block';
            }
            
            loadItems();
        }

        function applyShopDetails(index, shops) {
            shopName = shops[index].shopName;
            contactNumber = shops[index].contactNumber;
            address = formatAddress(shops[index].address);
            ownerName = shops[index].ownerName;

            document.getElementById('shop-title').innerText = shopName;
            document.getElementById('customer-info-page').style.display = 'block';
            document.getElementById('login-page').style.display = 'none';

            document.getElementById('card-shop-name').innerText = shopName;
            document.getElementById('card-owner-name').innerText = ownerName;
            document.getElementById('card-phone-number').innerText = `• ${contactNumber}`;
            document.getElementById('card-address').innerText = `• ${address}`;
        }

        function formatAddress(address) {
            return address.split(' ').reduce((acc, word, index) => {
                return acc + ((index % 3 == 0 && index !== 0) ? '\n' : ' ') + word;
            }, '').trim();
        }

        function generateQRCode() {
            const qrData = `BEGIN:VCARD
VERSION:3.0
FN:${shopName}
TEL:${contactNumber}
END:VCARD`;

            document.getElementById("card-qr-code").innerHTML = ""; // Clear previous QR code
            new QRCode(document.getElementById("card-qr-code"), {
                text: qrData,
                width: 90,
                height: 90,
                colorDark: "#000000",
                colorLight: "#ffffff"
            });
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
        }

        function downloadBusinessCard() {
            html2canvas(document.querySelector('#business-card'), {
                scale: 4,
                backgroundColor: null
            }).then(canvas => {
                const link = document.createElement('a');
                link.href = canvas.toDataURL("image/jpeg", 1.0);
                link.download = 'business-card.jpg';
                link.click();
            });
        }

        function showBusinessCardPage() {
            document.getElementById('customer-info-page').style.display = 'none';
            document.getElementById('business-card-page').style.display = 'block';
            generateQRCode(); // Ensure QR code is generated when page is shown
        }

        function changeTheme() {
            const card = document.getElementById('business-card');
            const randomColor1 = `#${Math.floor(Math.random() * 16777215).toString(16)}`;
            const randomColor2 = `#${Math.floor(Math.random() * 16777215).toString(16)}`;
            card.style.background = `linear-gradient(to right, ${randomColor1} 70%, ${randomColor2} 30%)`;
        }

        function selectShop() {
            const shopIndex = document.getElementById('existing-shops').value;
            if (shopIndex !== "") {
                localStorage.setItem('currentShopIndex', shopIndex);
                let shops = JSON.parse(localStorage.getItem('shops')) || [];
                applyShopDetails(shopIndex, shops);
            }
        }

        function createNewShop() {
            document.getElementById('shop-name').value = '';
            document.getElementById('contact-number').value = '';
            document.getElementById('address').value = '';
            document.getElementById('owner-name').value = '';
        }

        function login() {
            shopName = document.getElementById('shop-name').value;
            contactNumber = document.getElementById('contact-number').value;
            address = document.getElementById('address').value;
            ownerName = document.getElementById('owner-name').value;

            if (!shopName) {
                alert("Shop Name is required!");
                return;
            }

            let shops = JSON.parse(localStorage.getItem('shops')) || [];
            const newShop = { shopName, contactNumber, address, ownerName };
            shops.push(newShop);
            localStorage.setItem('shops', JSON.stringify(shops));
            localStorage.setItem('currentShopIndex', shops.length - 1);

            applyShopDetails(shops.length - 1, shops);
        }

        function submitCustomerInfo() {
            customerName = document.getElementById('customer-name').value;
            customerPhone = document.getElementById('customer-phone').value;

            if (!customerName || !customerPhone) {
                alert("Customer Name and Phone Number are required!");
                return;
            }

            document.getElementById('customer-info-page').style.display = 'none';
            document.getElementById('item-entry-page').style.display = 'block';
        }

        function loadItems() {
            let itemsList = JSON.parse(localStorage.getItem('itemsList')) || [];
            const itemSelect = document.getElementById('existing-items');
            itemSelect.innerHTML = '<option value="">Choose Existing Item</option>';
            itemsList.forEach(item => {
                let option = document.createElement('option');
                option.value = item.name;
                option.text = `${item.name} - ₹${item.price.toFixed(2)}`;
                itemSelect.add(option);
            });
        }

        function addItem() {
            const itemName = document.getElementById('item-name').value;
            const itemPrice = parseFloat(document.getElementById('item-price').value);
            const itemQuantity = parseInt(document.getElementById('item-quantity').value);

            if (itemName && !isNaN(itemPrice) && !isNaN(itemQuantity)) {
                items.push({ name: itemName, price: itemPrice, quantity: itemQuantity });
                saveItem(itemName, itemPrice);
                document.getElementById('item-name').value = '';
                document.getElementById('item-price').value = '';
                document.getElementById('item-quantity').value = '1';
                updateReceipt();
                loadItems();
            } else {
                alert("Please enter valid item name, price, and quantity.");
            }
        }

        function saveItem(name, price) {
            let itemsList = JSON.parse(localStorage.getItem('itemsList')) || [];
            if (!itemsList.some(item => item.name === name)) {
                itemsList.push({ name, price });
                localStorage.setItem('itemsList', JSON.stringify(itemsList));
            }
        }

        function selectExistingItem() {
            const selectedOption = document.getElementById('existing-items').value;
            if (selectedOption) {
                const itemsList = JSON.parse(localStorage.getItem('itemsList')) || [];
                const selectedItem = itemsList.find(item => item.name === selectedOption);
                if (selectedItem) {
                    document.getElementById('item-name').value = selectedItem.name;
                    document.getElementById('item-price').value = selectedItem.price;
                }
            }
        }

        function changeQuantity(amount) {
            const quantityInput = document.getElementById('item-quantity');
            let currentQuantity = parseInt(quantityInput.value, 10);

            currentQuantity += amount;

            if (currentQuantity < 1) {
                currentQuantity = 1; // Ensure quantity does not go below 1
            }

            quantityInput.value = currentQuantity;
        }

        function updateReceipt() {
    const currentDateTime = new Date().toLocaleString();
    let receiptContent = `<div class="centered-text" style="font-family: 'Impact', sans-serif; font-size: 30px; font-weight: bold; color: red; margin-bottom: 5px;"><strong>${shopName}</strong></div>`;
    receiptContent += `<div class="centered-text" style="padding: 10px 0; margin: 0; font-family: 'Courier New', Courier, monospace; font-size: 20px; font-weight: bold;"><strong>CASH RECEIPT</strong></div>`;
    receiptContent += `<div class="centered-text" style="font-family: 'Courier New', Courier, monospace; font-size: 12px;"><em>Invoice</em></div><br>`;
    receiptContent += `<div class="left-aligned-text">Customer: <strong>${customerName}</strong></div>`;
    receiptContent += `<div class="left-aligned-text">Mobile: <strong>${customerPhone}</strong></div>`;
    receiptContent += `<div class="left-aligned-text">Date & Time: ${currentDateTime}</div><br>`;
    receiptContent += `<table style="margin: 0 auto;"><tr><th>Item</th><th>Qty</th><th>Price (₹)</th><th>Total (₹)</th></tr>`;
    
    let total = 0; 
    items.forEach(item => {
        const itemTotal = item.price * item.quantity;
        receiptContent += `<tr><td>${item.name}</td><td>${item.quantity}</td><td>₹${item.price.toFixed(2)}</td><td>₹${itemTotal.toFixed(2)}</td></tr>`;
        total += itemTotal;
    }); 

    const gst = total * 0.18;
    const discount = gst;
    const finalTotal = total + gst - discount; 

    receiptContent += `</table><hr>`;
    receiptContent += `<div class="left-aligned-text">Subtotal: ₹${total.toFixed(2)}</div>`;
    receiptContent += `<div class="left-aligned-text">GST Charge: ₹${gst.toFixed(2)}</div>`;
    receiptContent += `<div class="left-aligned-text">Discount: ₹${discount.toFixed(2)}</div>`;
    receiptContent += `<div class="left-aligned-text"><strong>Total: ₹${finalTotal.toFixed(2)}</strong></div>`;
    receiptContent += `<div class="left-aligned-text" style="font-size: 12px;">Total Amount (in words): <strong>${convertNumberToWords(finalTotal)} Rupees</strong></div>`;
    receiptContent += `<div class="centered-text" style="margin-top: 10px; font-weight: bold;">THANK YOU VISIT AGAIN!</div>`;
    receiptContent += `<div class="barcode centered-text"><svg id="barcode"></svg></div>`;
    receiptContent += `<div class="left-aligned-text compact-info">${shopName}, ${address}<br>Contact: ${contactNumber}</div>`;
    receiptContent += `<div class="centered-text" style="font-size: 12px; margin-top: 10px;">Visit us at <strong>thedigitsync.blogspot.com</strong></div>`; 

    document.getElementById('receipt').innerHTML = receiptContent;
    document.getElementById('receipt').style.display = 'block'; 

    generateBarcode();
} 

        function convertNumberToWords(amount) {
            const words = ["Zero", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine", "Ten", "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen", "Sixteen", "Seventeen", "Eighteen", "Nineteen"];
            const tens = ["", "", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"];
            const scales = ["", "Thousand", "Lakh", "Crore"]; 

            if (amount === 0) return "Zero"; 

            let wordsArray = [];
            let scale = 0; 

            while (amount > 0) {
                const part = amount % 1000;
                if (part > 0) {
                    let partWords = convertThreeDigitNumberToWords(part);
                    if (scale > 0) {
                        partWords += " " + scales[scale];
                    }
                    wordsArray.unshift(partWords);
                }
                amount = Math.floor(amount / 1000);
                scale++;
            } 

            return wordsArray.join(" "); 

            function convertThreeDigitNumberToWords(num) {
                const hundred = Math.floor(num / 100);
                const remainder = num % 100;
                let result = ""; 

                if (hundred > 0) {
                    result += words[hundred] + " Hundred ";
                } 

                if (remainder > 0) {
                    if (remainder < 20) {
                        result += words[remainder];
                    } else {
                        const ten = Math.floor(remainder / 10);
                        const unit = remainder % 10;
                        result += tens[ten];
                        if (unit > 0) {
                            result += " " + words[unit];
                        }
                    }
                } 

                return result.trim();
            }
        }

        function generateBarcode() {
            const currentTime = new Date();
            const timeString = currentTime.toLocaleTimeString('it-IT').replace(/:/g, '').slice(0, 6);
            const days = ["SU", "MO", "TU", "WE", "TH", "FR", "SA"];
            const dayCode = days[currentTime.getDay()];

            const barcodeData = `${dayCode}${timeString}`;
            
            JsBarcode("#barcode", barcodeData, {
                format: "CODE39",
                lineColor: "#000",
                width: 1.9,
                height: 30,
                displayValue: true
            });
        }

        function printReceipt() {
            const printWindow = window.open('', '', 'height=600,width=400');
            printWindow.document.write('<html><head><title>Receipt</title><style>');
            printWindow.document.write('body { font-family: Arial, sans-serif; margin: 0; padding: 20px; text-align: left; }');
            printWindow.document.write('table { width: 100%; border-collapse: collapse; margin-top: 10px; }');
            printWindow.document.write('th, td { border: 1px solid #333; padding: 8px; text-align: left; }');
            printWindow.document.write('th { background-color: #007bff; color: white; }');
            printWindow.document.write('</style></head><body>');
            printWindow.document.write(document.getElementById('receipt').innerHTML);
            printWindow.document.close();
            printWindow.print();
        }

        function shareReceipt() {
    const receiptElement = document.getElementById('receipt');
    html2canvas(receiptElement, { 
        width: receiptElement.scrollWidth, // Capture the full width of the receipt
        scale: 2, // Higher scale for better resolution
        backgroundColor: '#ffffff',
        useCORS: true,
        onclone: (doc) => {
            const receipt = doc.getElementById('receipt');
            receipt.style.padding = '20px'; // Add padding for better visuals
            receipt.style.width = '100%'; // Ensure the receipt takes full width
            receipt.style.boxSizing = 'border-box'; // Include padding in width calculation
        }
    }).then(canvas => {
        canvas.toBlob(blob => {
            const file = new File([blob], "receipt.png", { type: "image/png" });
            const shareData = {
                title: 'Receipt',
                text: 'Here is your receipt!',
                files: [file]
            };
            navigator.share(shareData).then(() => {
                console.log('Receipt shared successfully!');
            }).catch(err => {
                console.error('Error while sharing:', err);
            });
            
        });
    });
}

        function notifyWhatsApp() {
            const currentDateTime = new Date().toLocaleString();
            const total = items.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const gst = total * 0.18;
            const discount = gst;
            const finalTotal = total + gst - discount;

            const barcodeElement = document.getElementById('barcode');
            const barcodeNumber = barcodeElement ? barcodeElement.textContent : '';

            const message = `Hi *${customerName}*,\n\nDetails of your Sale Invoice from *${shopName}*!\n\nReceipt Details:\n- Date & Time: ${currentDateTime}\n- Items: ${items.map(item => `${item.name} (${item.quantity}) - ₹${(item.price * item.quantity).toFixed(2)}`).join(', ')}\n- Subtotal: ₹${total.toFixed(2)}\n- GST Charge: ₹${gst.toFixed(2)}\n- Discount: ₹${discount.toFixed(2)}\n- Total: *₹${finalTotal.toFixed(2)}*\n\nShop Info:\n- Address: ${address}\n- Contact: ${contactNumber}\n- Barcode: ${barcodeNumber}\n\n_Visit us at our website: https://thedigitsync.blogspot.com/2024/11/free-custom-receipt-generator.html_\n\nThank you!`;

            const encodedMessage = encodeURIComponent(message);
            const formattedPhone = `91${customerPhone.replace(/^0+/, '')}`;
            const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }

        function resetItems() {
            saveReceipt();
            items = [];
            document.getElementById('receipt').innerHTML = '';
            document.getElementById('item-name').value = '';
            document.getElementById('item-price').value = '';
            document.getElementById('item-quantity').value = '1';
            document.getElementById('customer-info-page').style.display = 'block';
            document.getElementById('item-entry-page').style.display = 'none';
        }

        function saveReceipt() {
            const receiptData = {
                items: items,
                customerName: customerName,
                customerPhone: customerPhone,
                date: new Date().toLocaleString()
            };

            let receipts = JSON.parse(localStorage.getItem('receipts')) || [];
            receipts.push(receiptData);
            localStorage.setItem('receipts', JSON.stringify(receipts));
        }

        function loadHistory() {
            const historyContainer = document.getElementById('history');
            let receipts = JSON.parse(localStorage.getItem('receipts')) || [];
            receipts.reverse();

            historyContainer.innerHTML = receipts.map((receipt, index) => {
                const total = receipt.items.reduce((sum, item) => sum + item.price * item.quantity, 0);
                const receiptNumber = receipts.length - index;
                return `<div id="receipt-${index}" onmousedown="showDeleteOption(${index})" style="position: relative;">
                    <strong>Receipt #${receiptNumber}</strong><br>
                    Customer: ${receipt.customerName} (${receipt.customerPhone})<br>
                    Date: ${receipt.date}<br>
                    Items: ${receipt.items.map(item => `${item.name} (${item.quantity}) - ₹${(item.price * item.quantity).toFixed(2)}`).join(', ')}<br>
                    Total: ₹${total.toFixed(2)}<br>
                    <button id="delete-${index}" onclick="confirmDelete(${index})" style="display: none; position: absolute; right: 10px; top: 10px;">Delete</button>
                    <button onclick="downloadReceipt(${index})" style="position: absolute; right: 10px; top: 40px;">Download</button>
                    <hr>
                </div>`;
            }).join('');
        }

        function showHistory() {
            loadHistory();
            document.getElementById('history-page').style.display = 'block';
            document.getElementById('customer-info-page').style.display = 'none';
            document.getElementById('item-entry-page').style.display = 'none';
        }

        function showDeleteOption(index) {
            const deleteButton = document.getElementById(`delete-${index}`);
            deleteButton.style.display = 'block';
            setTimeout(() => {
                deleteButton.style.display = 'none';
            }, 3000);
        }

        function confirmDelete(index) {
            if (confirm("Are you sure you want to delete this receipt?")) {
                deleteReceipt(index);
            }
        }

        function deleteReceipt(index) {
            let receipts = JSON.parse(localStorage.getItem('receipts')) || [];
            const correctIndex = receipts.length - 1 - index;
            receipts.splice(correctIndex, 1);
            localStorage.setItem('receipts', JSON.stringify(receipts));
            loadHistory();
        }

        function exportToCSV() {
            let receipts = JSON.parse(localStorage.getItem('receipts')) || [];
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Shop Name,Owner,Receipt Number,Customer Name,Customer Phone,Total,Date\n";

            let grandTotal = 0;

            receipts.forEach((receipt, index) => {
                const total = receipt.items.reduce((sum, item) => sum + item.price * item.quantity, 0);
                grandTotal += total;
                csvContent += `${shopName},${ownerName},${index + 1},${receipt.customerName},${receipt.customerPhone},${total.toFixed(2)},${receipt.date}\n`;
            });

            csvContent += `,,,,Grand Total,${grandTotal.toFixed(2)}\n`;

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "sales_history.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showSettings() {
            document.getElementById('customer-info-page').style.display = 'none';
            document.getElementById('settings-page').style.display = 'block';

            document.getElementById('edit-shop-name').value = shopName;
            document.getElementById('edit-contact-number').value = contactNumber;
            document.getElementById('edit-address').value = address;
            document.getElementById('edit-owner-name').value = ownerName;
        }

        function saveSettings() {
            shopName = document.getElementById('edit-shop-name').value;
            contactNumber = document.getElementById('edit-contact-number').value;
            address = document.getElementById('edit-address').value;
            ownerName = document.getElementById('edit-owner-name').value;

            if (!shopName) {
                alert("Shop Name is required!");
                return;
            }

            let shops = JSON.parse(localStorage.getItem('shops')) || [];
            const currentShopIndex = localStorage.getItem('currentShopIndex');
            shops[currentShopIndex] = { shopName, contactNumber, address, ownerName };
            localStorage.setItem('shops', JSON.stringify(shops));

            applyShopDetails(currentShopIndex, shops);
            goBack();
        }

        function logout() {
            document.getElementById('customer-info-page').style.display = 'none';
            document.getElementById('item-entry-page').style.display = 'none';
            document.getElementById('history-page').style.display = 'none';
            document.getElementById('settings-page').style.display = 'none';
            document.getElementById('login-page').style.display = 'block';
        }

        function goBack() {
            document.querySelectorAll('.page').forEach(page => page.style.display = 'none');
            document.getElementById('customer-info-page').style.display = 'block';
        }

        function downloadReceipt(index) {
            let receipts = JSON.parse(localStorage.getItem('receipts')) || [];
            const correctIndex = receipts.length - 1 - index;
            const receipt = receipts[correctIndex];

            let receiptContent = `<div style="text-align: center; font-family: 'Impact', sans-serif; font-size: 30px; font-weight: bold; color: red; margin-bottom: 5px;"><strong>${shopName}</strong></div>`;
            receiptContent += `<div style="text-align: center; padding: 10px 0; margin: 0; font-family: 'Courier New', Courier, monospace; font-size: 26px; font-weight: bold;"><strong>CASH RECEIPT</strong></div>`;
            receiptContent += `<div style="text-align: center; font-family: 'Courier New', Courier, monospace; font-size: 12px;"><em>Invoice</em></div><br>`;
            receiptContent += `Customer: <strong>${receipt.customerName}</strong><br>`;
            receiptContent += `Mobile: <strong>${receipt.customerPhone}</strong><br>`;
            receiptContent += `Date & Time: ${receipt.date}<br><br>`;
            receiptContent += `<table style="margin: 0 auto;"><tr><th>Item</th><th>Quantity</th><th>Price (₹)</th><th>Total (₹)</th></tr>`;
            receipt.items.forEach(item => {
                const itemTotal = item.price * item.quantity;
                receiptContent += `<tr><td>${item.name}</td><td>${item.quantity}</td><td>₹${item.price.toFixed(2)}</td><td>₹${itemTotal.toFixed(2)}</td></tr>`;
            });
            const total = receipt.items.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const gst = total * 0.18;
            const discount = gst;
            const finalTotal = total + gst - discount;

            receiptContent += `</table><hr>Subtotal: ₹${total.toFixed(2)}<br>`;
            receiptContent += `GST Charge: ₹${gst.toFixed(2)}<br>`;
            receiptContent += `Discount: ₹${discount.toFixed(2)}<br>`;
            receiptContent += `<strong style="font-size: 18px; color: black;">Total: ₹${finalTotal.toFixed(2)}</strong><br>`;
            receiptContent += `<div style="font-size: 12px;">Total Amount (in words): <strong>${convertNumberToWords(finalTotal)} Rupees</strong></div>`;
            receiptContent += `<div style="margin-top: 10px; font-weight: bold; text-align: center;">Thank You!</div>`;
            receiptContent += `<div class="compact-info">${shopName}, ${address}<br>Contact: ${contactNumber}</div>`;

            const printWindow = window.open('', '', 'height=600,width=400');
            printWindow.document.write('<html><head><title>Receipt</title><style>');
            printWindow.document.write('body { font-family: Arial, sans-serif; margin: 0; padding: 20px; text-align: left; }');
            printWindow.document.write('table { width: 100%; border-collapse: collapse; margin-top: 10px; }');
            printWindow.document.write('th, td { border: 1px solid #333; padding: 8px; text-align: left; }');
            printWindow.document.write('th { background-color: #007bff; color: white; }');
            printWindow.document.write('</style></head><body>');
            printWindow.document.write(receiptContent);
            printWindow.document.close();
            printWindow.print();
        }
    </script>

</body>
</html>
